---
title: "Barrios Clase Media"
author: "Lucas S. Melfi"
date: "2025-07-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Librerías}
library(tidyverse)
library(sf)
library(leaflet)
library(fs)
library(osmdata)
library(osrm)
library(openrouteservice)
```


```{r Urls}

url_barrios2 <- "https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-desarrollo-humano-y-habitat/barrios-populares"

url_comunas <- "https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-educacion/comunas/comunas.geojson"

url_barrioscaba <- "https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-educacion/barrios/barrios.geojson"

url_educativos <- "https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-educacion/establecimientos-educativos/establecimientos_educativos.geojson"

url_radiocensalcaba <- "https://cdn.buenosaires.gob.ar/datosabiertos/datasets/direccion-general-de-estadisticas-y-censos/informacion-censal-por-radio/caba_radios_censales.geojson"

url_radiosamba <- "https://cdn.produccion.gob.ar/cdn-cep/amba-aportantes/Shapes.rar"

url_radiosocioeco <- "https://cdn.produccion.gob.ar/cdn-cep/amba-aportantes/Empleo-AMBA.csv"

```

# 1ra Parte: Barrios de clase media y alta de Ciudad Autonoma de Buenos Aires

```{r Carga de Mapa base Radio Censales AMBA}

td <- tempdir()
rar_path <- path(td, "Shapes.rar")
download.file(url = url_radiosamba, destfile = rar_path, mode = "wb")
system(paste('"D:/PROGRAMS-HDD/Winrar/WinRAR.exe" x', shQuote(rar_path), shQuote(td)))
list.files(td, pattern = "\\.shp$", recursive = TRUE)
radios2 <- read_sf(path(td, "Shapes", "Shape AMBA.shp"))
list.files(td, recursive = TRUE)
rm(td)
st_crs(radios2)
sum(!st_is_valid(radios2))
radios2 <- st_transform(radios2, 5347)
```


```{r Carga Dataset ingreso medio AMBA (2022)}

radio_socioeco <- read.csv(url_radiosocioeco, fileEncoding = "latin1")
```

```{r Join Espacial con No espacial: Radio Censales e Ingreso}

mapa_eco <- left_join(radios2, radio_socioeco, by = c("CO_FRAC_RA" = "LINK" ) ) %>%
  filter(!is.na(Remuneracion_media)) 
rm(radio_socioeco)
```

```{r Clasificacion por de ingreso en cuartiles}
cuartiles <- quantile(mapa_eco$Remuneracion_media, probs = c(0.25, 0.50, 0.75), na.rm = TRUE)
bairescm_q <- mapa_eco %>%
  filter(provincia_id == 2, Remuneracion_media > 30000) %>% #Recortamos CABA
  mutate(cluster = case_when(
    Remuneracion_media <= cuartiles[1] ~ "Clase baja",  #Dividimos el ingreso en cuartiles
    Remuneracion_media <= cuartiles[2] ~ "Clase media",
    Remuneracion_media <= cuartiles[3] ~ "Clase media alta",
    TRUE ~ "Clase alta"
  ))
```


```{r}
#Cargamos el mapa de barrios y le transformamos el crs
barrioscm_caba <- st_read(url_barrioscaba)
st_crs(barrioscm_caba)
sum(!st_is_valid(barrioscm_caba))
barrioscm_caba <- st_transform(barrioscm_caba, 5347)


```

```{r Join mapa de barrios y  radiocensales con seleccion de columnas}

barrios_cm_sj <- st_join(bairescm_q, barrioscm_caba, join = st_intersects)

barrioscm_sjs <- barrios_cm_sj %>%
  select(CO_FRAC_RA, geometry, Remuneracion_media, cluster, nombre, comuna, perimetro_, area_metro) %>%
  rename(barrios_nom = nombre)
rm(bairescm_q)
rm(barrioscm_caba)

```


```{r Agrupación y filtrado radiocensales por barrio con toma de  muestra}
#Agrupamos por barrios y filtramos los que nos interesan 
barrioscm_selec <- barrioscm_sjs %>%
  filter(barrios_nom == "Palermo" & cluster == "Clase alta" | 
           barrios_nom == "Caballito" & cluster == "Clase media alta"|
           barrios_nom == "Almagro" & cluster == "Clase media" ) %>%
  group_by(barrios_nom) %>%
  arrange(desc (Remuneracion_media)) %>%
  slice_head(n=8) %>%
  ungroup()
#rm(barrioscm_sjs)
```

```{r Primera visualizacion: radiocensales elegidos de CABA  }

#Cargamos un mapa de radiocensales de CABA para que nos oficie de mapa base para la visualización
radio_bsas <-  st_read(url_radiocensalcaba)
st_crs(radio_bsas)
sum(!st_is_valid(radio_bsas))
radio_bsas <- st_transform(radio_bsas, 5347)

```




```{r Primera visualizacion: Radiocensales elegidos por barrio}

#Visualizamos
ggplot() + 
  geom_sf(data = radio_bsas, fill = "grey90", color = "black") +
  geom_sf(data = barrioscm_selec, aes(fill = barrios_nom), color = "white", size = 0.2) +
  scale_fill_brewer(palette = "Set1") +
  labs(
    title = "Muestra de radios censales por barrio",
    subtitle = "8 Radios censales por barrio elegido",
    fill = "barrios_nom (Barrios)",
    color = "black"
  ) +
  theme_minimal()
```






```{r Carga de escuelas}
#cargamos las escuelas
educ <- st_read(url_educativos)
sum(!st_is_valid(educ))
educ <- st_transform(educ, 5347) %>% 
  select(escuela = nam , tipo_gestion = ges,  nivel = nen_mde, tipo = tip, geom_edu = geometry)
educ_sna <- educ %>% filter(!is.na(tipo_gestion)) #sacamos los na
rm(educ)
```


```{r Operaciones espaciales: Buffers y conteo de escuelas}

buff_cm_500  <- barrioscm_selec %>% st_buffer(500) %>% mutate(buffer = "500m")
buff_cm_1000 <- barrioscm_selec %>% st_buffer(1000) %>% mutate(buffer = "1000m")
buff_cm_2000 <- barrioscm_selec %>% st_buffer(2000) %>% mutate(buffer = "2000m")

buffers_cm_bind <- bind_rows(buff_cm_500, buff_cm_1000, buff_cm_2000)

escuelas_cmbuffer <- st_join(educ_sna, buffers_cm_bind, join = st_intersects)


conteo_escuelas_cm <- escuelas_cmbuffer %>% 
  filter(!is.na(barrios_nom), !is.na(buffer)) %>%
  st_drop_geometry() %>%           # 👈 Quita geometría
  distinct(escuela, buffer, barrios_nom) %>%
  group_by(barrios_nom, buffer) %>%
  summarise(total = n(), .groups = "drop")

```

```{r Primera Tabla}
tabla_resumen <- conteo_escuelas_cm %>%
  pivot_wider(
    names_from = buffer,
    values_from = total
  ) %>%
  mutate(Sum = rowSums(across(where(is.numeric))))
print (tabla_resumen)
```


```{r Segunda visualización: Grafico de conteo}

ggplot(conteo_escuelas_cm, aes(x = barrios_nom, y = total, fill = buffer)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c(
    "500m" = "#1b9e77",    
    "1000m" = "#d95f02",   
    "2000m" = "#7570b3"    
  )) +
  labs(title = "Escuelas cercanas a barrios de clase media/alta",
       x = "Barrio", y = "Cantidad de escuelas", fill = "Distancia") +
  theme_minimal()


```


```{r Tercera visualizacion: Grafico de conteo 2}
ggplot(conteo_escuelas_cm, aes(x = reorder (buffer, total), y = total, fill = buffer)) +
  geom_col() +
  facet_wrap(~barrios_nom) +
  labs(
    title = "Escuelas dentro del radio de cada barrio",
    x = "Distancia",
    y = "Cantidad de escuelas"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Set2")

```



```{r Cuarta visualización: Mapa de buffers y escuelas}

buffers_cm_bind$buffer <- factor(buffers_cm_bind$buffer, 
                                 levels = c("500m", "1000m", "2000m"))


ggplot() +
  # Mapa base
  geom_sf(data = radio_bsas, fill = "grey90", color = "black", size = 0.1) +
  
  # Buffers con transparencia
  geom_sf(data = buffers_cm_bind, 
          aes(fill = buffer), 
          color = "red", alpha = 0.2) +
  
  # Escuelas dentro de los buffers
  geom_sf(data = escuelas_cmbuffer, 
          aes(color = tipo_gestion), 
          size = 2) +
 
  # Colores para buffers y gestión
  scale_fill_manual(values = c("500m" = "blue", 
                               "1000m" = "skyblue", 
                               "2000m" = "red")) +
  scale_color_manual(values = c("Privada" = "purple", 
                                "Estatal" = "green")) +
  
  labs(title = "Escuelas dentro de buffers de radios censales",
       subtitle = "Buffers a 500m, 1000m y 2000m - Colores por gestión",
       fill = "Distancia",
       color = "Gestión") +
  
  theme_minimal()

```


```{r}
escuelascm_filtradas <- st_filter(educ_sna, buffers_cm_bind)

ggplot() +
  geom_sf(data = radio_bsas, fill = "grey90", color = "black", size = 0.1) +
  geom_sf(data = buffers_cm_bind, aes(fill = buffer), color = "red", alpha = 0.2) +
  geom_sf(data = escuelascm_filtradas, aes(color = tipo_gestion), size = 2) +
  scale_fill_manual(values = c("500m" = "blue", "1000m" = "skyblue", "2000m" = "red")) +
  scale_color_manual(values = c("Privada" = "purple", "Estatal" = "green")) +
  labs(
    title = "Escuelas dentro de buffers de radios censales",
    subtitle = "Buffers a 500m, 1000m y 2000m - Colores por gestión",
    fill = "Distancia",
    color = "Gestión"
  ) +
  theme_minimal()

```





```{r Quinta visualización: Facetado de buffers y escuelas}

ggplot() +
  geom_sf(data = radio_bsas, fill = "grey90", color = "black", size = 0.1) + #Mapa fondo
  geom_sf(data = buffers_cm_bind, aes(color = buffer), fill = NA, size = 2) + #Buffers
  geom_sf(data = escuelascm_filtradas, aes(fill = tipo_gestion), #Escueas en cobertura 
          color = "black", size = 1, shape = 21, alpha = 0.6) + 
  scale_color_manual( #color de bordes buffers
    values = c("500m" = "red", 
               "1000m" = "blue", 
               "2000m" = "green")
  ) +
  scale_fill_manual(    # Color de puntos de escuela
    values = c("Privada" = "purple", 
               "Estatal" = "yellow")
  ) +
  
  labs(
    title = "Escuelas dentro de buffers de radios censales",
    subtitle = "Facetado por barrio",
    color = "Cobertura (Buffer)",
    fill = "Tipo de gestión"
  ) +
  
  theme_minimal() +
  facet_wrap(~ barrios_nom)


```


```{r Sexta visualización: Interactiva}

buffers_cm_bind_wgs <- st_transform(buffers_cm_bind, 4326)
escuelascm_filtradas_wgs <- st_transform(escuelascm_filtradas, 4326)
radio_bsas_wgs <- st_transform(radio_bsas, 4326)

leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  
  # Buffers - bordes de colores
  addPolylines(data = buffers_cm_bind_wgs,
               color = ~case_when(
                 buffer == "500m" ~ "red",
                 buffer == "1000m" ~ "blue",
                 buffer == "2000m" ~ "green"
               ),
               weight = 2,
               opacity = 0.8,
               label = ~paste("Cobertura:", buffer)) %>%
  
  # Escuelas - puntos según gestión
  addCircleMarkers(data = escuelascm_filtradas_wgs,
                   color = "black", 
                   fillColor = ~case_when(
                     tipo_gestion == "Privada" ~ "purple",
                     tipo_gestion == "Estatal" ~ "yellow"
                   ),
                   fillOpacity = 0.8,
                   radius = 5,
                   popup = ~paste("Escuela:", escuela,
                                  "<br>Gestión:", tipo_gestion)) %>%
  
  # Límites de radios censales (opcional)
  addPolygons(data = radio_bsas_wgs,
              color = "black", 
              weight = 0.5,
              fillOpacity = 0,
              group = "Radios censales") %>%
  
  addLayersControl(
    overlayGroups = c("Radios censales"),
    options = layersControlOptions(collapsed = FALSE)
  )

```



```{r}
leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  
  # Buffers primero (debajo)
  addPolylines(
    data = buffers_cm_bind_wgs,
    color = ~case_when(
      buffer == "500m" ~ "red",
      buffer == "1000m" ~ "blue",
      buffer == "2000m" ~ "green"
    ),
    weight = 2,
    opacity = 0.8,
    label = ~paste("Cobertura:", buffer),
    options = pathOptions(interactive = FALSE),
    group = "Buffers"
  ) %>%
  
  # Escuelas después (arriba)
  addCircleMarkers(
    data = escuelascm_filtradas_wgs,
    color = "black", 
    fillColor = ~case_when(
      tipo_gestion == "Privada" ~ "purple",
      tipo_gestion == "Estatal" ~ "yellow"
    ),
    fillOpacity = 0.8,
    radius = 5,
    popup = ~paste0("<strong>Escuela: </strong>", escuela,
                    "<br><strong>Gestión: </strong>", tipo_gestion),
    group = "Escuelas"
  ) %>%
  
  addLegend(
    position = "bottomright",
    colors = c("red", "blue", "green"),
    labels = c("500m", "1000m", "2000m"),
    title = "Buffer - Distancia"
  )

```


```{r Geoconsulta: Preparación}
#Para la geoconsulta trabajamos con geometria de puntos, mas liviana.
barrioscm_puntos <- barrioscm_selec %>%
  st_point_on_surface()%>%
  select(CO_FRAC_RA, barrios_nom, cluster, Remuneracion_media, area_metro, geometry) %>%
  arrange(desc(area_metro)) 


buffcm500_punto <- barrioscm_puntos %>% st_buffer(500)  %>% mutate(buffer = "500m") 
#Rebuffereo 

escuelascm_500 <- st_filter(educ_sna, buffcm500_punto) 
#Filtrado de escuelas dentro de cada buffer



```


```{r Geoconsulta: Osrm}


# 2. Configuramos OSRM en modo a pie
options(osrm.profile = "foot")

# 3. Transformamos el CRS a 4326 para la geocon
barrioscm_puntos <- st_transform(barrioscm_puntos, 4326)
escuelascm_500 <- st_transform(escuelascm_500, 4326)

# 4. Calculamos tiempos para 500m
tabla_tiemposcm_500 <- osrmTable(src = barrioscm_puntos, dst = escuelascm_500)
df_tiemposcm_500 <- as.data.frame(tabla_tiemposcm_500$durations)
df_tiemposcm_500$radio_id <- rownames(df_tiemposcm_500)
df_tiemposcm_larga_500 <- df_tiemposcm_500 %>%
  pivot_longer(
    cols = -radio_id, 
    names_to = "id_escuela", 
    values_to = "tiempo_min") %>%
  mutate(buffer = "500m")
print(df_tiemposcm_larga_500)



```

```{r Septima visualización: Tiempos promedio ordenados de mayor a menor}

df_resumen <- df_tiemposcm_larga_500 %>%
  group_by(radio_id) %>%
  summarise(tiempo_promedio = mean(tiempo_min, na.rm = TRUE))

ggplot(df_resumen, aes(x = reorder(radio_id, tiempo_promedio), y = tiempo_promedio)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(
    title = "Tiempo promedio a escuelas (500m)",
    x = "Radio censal",
    y = "Tiempo promedio (minutos)"
  ) +
  theme_minimal()

```






