---
title: "Tp_movilidad_cdde2"
author: "Lucas S. Melfi"
date: "2025-05-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Librerías}
library(tidyverse)
library(here)
library(sf)
library(nngeo)
library(leaflet)
library(fs)
library(osmdata)
library(osrm)
library(openrouteservice)
```


```{r Urls}


url_barrios2 <- "https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-desarrollo-humano-y-habitat/barrios-populares"

url_comunas <- "https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-educacion/comunas/comunas.geojson"

url_barrioscaba <- "https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-educacion/barrios/barrios.geojson"

url_educativos <- "https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-educacion/establecimientos-educativos/establecimientos_educativos.geojson"

url_radiocensalcaba <- "https://cdn.buenosaires.gob.ar/datosabiertos/datasets/direccion-general-de-estadisticas-y-censos/informacion-censal-por-radio/caba_radios_censales.geojson"

url_radiosamba <- "https://cdn.produccion.gob.ar/cdn-cep/amba-aportantes/Shapes.rar"

url_radiosocioeco <- "https://cdn.produccion.gob.ar/cdn-cep/amba-aportantes/Empleo-AMBA.csv"



```



```{r}
#Cargamos el mapa de barrios y le transformamos el crs
barrioscm_caba <- st_read(url_barrioscaba)
st_crs(barrioscm_caba)
sum(!st_is_valid(barrioscm_caba))
barrioscm_caba <- st_transform(barrioscm_caba, 5347)


```



```{r Primera visualizacion: radiocensales elegidos de CABA  }


```



```{r Carga de escuelas}
#cargamos las escuelas
educ <- st_read(url_educativos)
sum(!st_is_valid(educ))
educ <- st_transform(educ, 5347) %>% 
  select(escuela = nam , tipo_gestion = ges,  nivel = nen_mde, tipo = tip, geom_edu = geometry)
educ_sna <- educ %>% filter(!is.na(tipo_gestion)) #sacamos los na
rm(educ)
```


#2da Parte: Barrios Populares de Ciudad Autonoma de Buenos Aires

```{r Barrios Populares}
td <- tempdir()
  download.file(url = paste(url_barrios2,
                            "barrios-populares-badata.zip",
                            sep = "/"),
                destfile = fs::path(td, "barrios-populares-badata.zip") )
  unzip(zipfile = fs::path(td, "barrios-populares-badata.zip"),
        exdir = td)
  barrios_vul <- read_sf(fs::path(td, "barrios_vulnerables.shp"))
  rm(td)  
st_crs(barrios_vul)
sum(!st_is_valid(barrios_vul))
barrios_vul <- st_transform(barrios_vul, 5347)
   

```
#Barrios populares 
Capa que contiene el registro de los denominados barrios poulares de la Ciudad Autonoma de Buenos Aires. Dichos barrios son considerados las zonas precarias y vulnerables.
#TIPO_ASENT		
Tipo de registro: Villa, Asentamiento precario, Barrio municipal, Barrio urbanizado, Conjunto habitacional, Núcleo habitacional transitorio. Son categorías definidas según el Ministerio de Desarrollo y Hábitat en Junio de 2020.


```{r Primera visualziación: Barrios Vulnerables de CABA en Radio Censales}

#Cargamos un mapa de radiocensales de CABA para que nos oficie de mapa base para la visualización
radio_bsas <-  st_read(url_radiocensalcaba)
st_crs(radio_bsas)
sum(!st_is_valid(radio_bsas))
radio_bsas <- st_transform(radio_bsas, 5347)


```


```{r}
#Primera visualizacion barrios pop en radio censales
ggplot() +
  geom_sf(data = radio_bsas, fill = "grey90", color = "black", size = 0.1) +
  geom_sf(data = barrios_vul, fill = "red", color = "red", alpha = 1) +
  labs(title = "Ubicación de barrios populares  de CABA - Radiocensales",
       fill = "Comuna") +
  theme_minimal()
```


```{r Segunda visualización: Mapa interactivo de barrios vulnerables}

comunas_caba <- st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-educacion/comunas/comunas.geojson")

leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data = st_transform (barrioscm_caba, 4326),
              fillColor = "transparent",
              color = "black",
              weight = 1,
              label = ~nombre)%>%
  addPolygons(data = st_transform (barrios_vul,4326),
              fillColor = "red",
              color = "darkred",
              weight = 1,
              fillOpacity = 0.6,
              label = ~NOMBRE)
```



#Barrios populares 
Capa que contiene el registro de los denominados barrios poulares de la Ciudad Autonoma de Buenos Aires. Dichos barrios son considerados las zonas precarias y vulnerables.
#TIPO_ASENT		
Tipo de registro: Villa, Asentamiento precario, Barrio municipal, Barrio urbanizado, Conjunto habitacional, Núcleo habitacional transitorio. Son categorías definidas según el Ministerio de Desarrollo y Hábitat en Junio de 2020.

#Comunas
Este conjunto de datos proporciona información sobre la ubicación, perímetro y área de las comunas de la Ciudad de Buenos Aires, establecidas a partir de la Ley Orgánica de Comunas (Ley Nº 1777/2005). La información permite analizar la distribución territorial y la organización administrativa de la ciudad, facilitando estudios de planificación urbana y gestión pública.



```{r Selección de 3 barrios populares y muestra de 8 radiocensales de cada uno}
#Hacemos el space join entre los barrios y los radiocensales, para unir solo las partes de la geometria, es decir los radiocensales, que se intersectan con los barrios populares
radios2 <- st_transform(radios2, 5347)
barrios_vul <- st_transform(barrios_vul, 5347)
barrios_vul_rs <- st_join(radios2, barrios_vul, join = st_intersects) %>% 
  filter(NOMBRE %in% c("Villa 31","Villa 31 - Padre Mugica", 
                       "Villa 21-24", "Villa 15 - Ciudad Oculta")) %>% 
  mutate(NOMBRE = case_when(
    NOMBRE == "Villa 15 - Ciudad Oculta" ~ "Villa_15",
    NOMBRE == "Villa 31 - Padre Mugica" ~ "Villa_31",
    NOMBRE == "Villa 21-24" ~ "Villa_21_24",
    TRUE ~ "Villa_31"
  )) %>% 
  rename(barrios_nom = NOMBRE)

barriosvul_selec <- barrios_vul_rs %>% 
  group_by(barrios_nom) %>% 
  arrange(desc(Superficie)) %>% 
  slice_head(n = 8) %>%
  ungroup()
  
rm(barrios_vul)
rm(barrios_vul_rs)


```

```{r Operaciones espaciales: Bufferrs y conteo de escuelas en zonas vulnerables }
buffvul_500  <- barriosvul_selec %>% st_buffer(500) %>% mutate(buffer = "500m")
buffvul_1000 <- barriosvul_selec %>% st_buffer(1000) %>% mutate(buffer = "1000m")
buffvul_2000 <- barriosvul_selec %>% st_buffer(2000) %>% mutate(buffer = "2000m")

buffersvul_bind <- bind_rows(buffvul_500, buffvul_1000, buffvul_2000)

escuelasvul_buffer <- st_join(educ_sna, buffersvul_bind, join = st_intersects)

conteo_escuelasvul <- escuelasvul_buffer %>% 
  filter(!is.na(barrios_nom), !is.na(buffer)) %>%
  st_drop_geometry() %>%           
  distinct(escuela, buffer, barrios_nom) %>%
  group_by(barrios_nom, buffer) %>%
  summarise(total = n(), .groups = "drop")
print(conteo_escuelasvul)

```

```{r}

```

```{r}
tablavul_resumen <- conteo_escuelasvul %>%
  pivot_wider(
    names_from = buffer,
    values_from = total
  ) %>%
  mutate(Sum = rowSums(across(where(is.numeric))))
print (tablavul_resumen)
```



```{r Muestra de 8 radiocensales en geometria punto  de los tres barrios populares elegidos}
#Esto lo hacemos para no pagar tanto costo computacional en las oepraciones, sobre todo geoconsultas
barrios_vul_puntos <- barrios_vul_selec %>%
  st_point_on_surface() %>%
  select(Id, barrios_nom, CO_FRAC_RA, TIPO_ASENT,MANZANA, Superficie, geometry)  
  
#Agrupamos y tomamos los 8 radiocensales mas extensos en superficie de cada barrio popular
radios_vul8 <- barrios_vul_puntos %>% 
  group_by(barrios_nom) %>% 
  arrange(desc(Superficie)) %>% 
  slice_head(n = 8) %>%
  ungroup()


```

```{r Buffers}

buff_vul_500  <- barrios_vul_puntos %>% st_buffer(500)  %>% mutate(buffer = "500m")
buff_vul_1000 <- barrios_vul_puntos %>% st_buffer(1000) %>% mutate(buffer = "1000m")
buff_vul_2000 <- barrios_vul_puntos %>% st_buffer(2000) %>% mutate(buffer = "2000m")
buffers_vul_bind <- bind_rows(buff_vul_500, buff_vul_1000, buff_vul_2000)
escuelas_vul_filto <- st_filter(educ_sna, buffers_vul_bind)
escuelas_vulbuffer <- st_join(escuelas_vul_filto, buffers_vul_bind, join = st_intersects) %>%
  filter(!is.na (tipo_gestion))
conteo_escuelasvulpun <- escuelas_vulbuffer %>%
  group_by(escuela, buffer, barrios_nom) %>%
  summarise(total = n())

```

```{r}
tabla_resumen_vul <- table(conteo_escuelasvulpun$barrios_nom, conteo_escuelasvulpun$buffer)
addmargins(tabla_resumen_vul)
```



```{r}

ggplot(conteo_escuelasvul, aes(x = barrios_nom, y = total, fill = buffer)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c(
    "500m" = "#1b9e77",    
    "1000m" = "#d95f02",   
    "2000m" = "#7570b3"    
  )) +
  labs(title = "Escuelas cercanas a barrios vulnerables",
       x = "Barrio", y = "Cantidad de escuelas", fill = "Distancia") +
  theme_minimal()
```

```{r}
ggplot(escuelasvul_buffer, aes(x = barrios_nom, fill = tipo_gestion)) +
  geom_bar( position = "dodge") +
  scale_fill_manual(values = c(
    "Estatal" = "#1b9e77",    
    "Privada" = "#d95f02" )) +
  labs(title = "Escuelas cercanas a barrios de clase media/alta",
       x = "Barrio", y = "Cantidad de escuelas", fill = "tipo_gestion (Gestion)") +
  theme_minimal()
```




```{r}
ggplot(conteo_escuelasvul, aes(x = buffer, y = total, fill = buffer)) +
  geom_col() +
  facet_wrap(~barrios_nom) +
  labs(
    title = "Escuelas dentro del radio de cada barrio",
    x = "Distancia",
    y = "Cantidad de escuelas"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_fill_brewer(palette = "Set2")

```



```{r Visualización: Buffers y escuelas de barrios vulnerables}

buffersvul_bind$buffer <- factor(buffersvul_bind$buffer, 
                                 levels = c("500m", "1000m", "2000m"))


ggplot() +
  geom_sf(data = radio_bsas, fill = "grey95", color = "black", size = 0.1) +
  geom_sf(
    data = buffersvul_bind,
    aes(fill = buffer),
    color = "red",alpha = 0.05) +
  geom_sf(
    data = escuelasvul_buffer, 
    aes(color = tipo_gestion), 
    size = 2) +
  scale_fill_manual(
    values = c("500m" = "blue", 
               "1000m" = "skyblue", 
               "2000m" = "red")) +
  scale_color_manual(values = c("Estatal" = "green", 
                                "Privada" = "purple"))+
  theme_minimal() +
  labs(
    title = "Escuelas dentro de buffers de barrios vulnerables",
    fill = "Rango de distancia",
    color = "Tipo de gestión"
  )
```



```{r}
ggplot() +
  geom_sf(data = radio_bsas, fill = "grey95", color = "black") +
  geom_sf(
    data = anillos2,
    aes(fill = buffer),
    color = "black",
    alpha = 0.1
  ) +
  geom_sf(
    data = escuelas_vulbuffer, 
    aes(color = tipo_gestion), 
    size = 1
  ) +
  scale_fill_manual(
    values = c("0-500m" = "red", "500-1000m" = "orange", "1000-2000m" = "blue")
  ) +
  theme_minimal() +
  labs(
    title = "Escuelas dentro de anillos de barrios vulnerables",
    fill = "Rango de distancia",
    color = "Tipo de gestión"
  ) +
  facet_wrap(~ barrios_nom)  # 👈 facetado por barrio

```


```{r}
escuelasvul_filtradas <- st_filter(educ_sna, buffersvul_bind)
ggplot() +
  geom_sf(data = radio_bsas, fill = "grey90", color = "black", size = 0.1) +
  geom_sf(data = buffersvul_bind, aes(fill = buffer), color = "red", alpha = 0.2) +
  geom_sf(data = escuelasvul_filtradas, aes(color = tipo_gestion), size = 2) +
  scale_fill_manual(values = c("500m" = "blue", "1000m" = "skyblue", "2000m" = "red")) +
  scale_color_manual(values = c("Privada" = "purple", "Estatal" = "green")) +
  labs(
    title = "Escuelas dentro de buffers de radios censales",
    subtitle = "Buffers a 500m, 1000m y 2000m - Colores por gestión",
    fill = "Distancia",
    color = "Gestión"
  ) +
  theme_minimal()
```
```{r}
ggplot() +
  geom_sf(data = radio_bsas, fill = "grey90", color = "black", size = 0.1) + #Mapa fondo
  geom_sf(data = buffersvul_bind, aes(color = buffer), fill = NA, size = 2) + #Buffers
  geom_sf(data = escuelasvul_filtradas, aes(fill = tipo_gestion), #Escueas en cobertura 
          color = "black", size = 1, shape = 21, alpha = 0.6) + 
  scale_color_manual( #color de bordes buffers
    values = c("500m" = "red", 
               "1000m" = "blue", 
               "2000m" = "green")
  ) +
  scale_fill_manual(    # Color de puntos de escuela
    values = c("Privada" = "purple", 
               "Estatal" = "yellow")
  ) +
  
  labs(
    title = "Escuelas vulnerables dentro de buffers de radios censales",
    subtitle = "Facetado por barrio",
    color = "Cobertura (Buffer)",
    fill = "Tipo de gestión"
  ) +
  
  theme_minimal() +
  facet_wrap(~ barrios_nom)
```



```{r}
leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  
  # Base: radio de Buenos Aires
  addPolygons(
    data = st_transform(radio_bsas, 4326),
    fillColor = "transparent",
    color = "black",
    weight = 1,
    label = ~"CABA",
    group = "Base"
  ) %>%
  
  # Buffers solo con borde coloreado
  addPolygons(
    data = st_transform(buffersvul_bind, 4326),
    fillColor = "transparent",          # Sin relleno
    color = ~case_when(
      buffer == "500m" ~ "red",
      buffer == "1000m" ~ "orange",
      buffer == "2000m" ~ "blue",
      TRUE ~ "black"
    ),
    weight = 2,
    fillOpacity = 0,                     # Transparente
    label = ~buffer,
    group = "Buffers",
    highlightOptions = highlightOptions(weight = 3, color = "grey"),
    options = pathOptions(interactive = FALSE)
  ) %>%
  
  # Escuelas como puntos
  addCircleMarkers(
    data = st_transform(escuelasvul_filtradas, 4326),
    color = ~ifelse(tipo_gestion == "Privada", "blue", "green"),
    radius = 2,
    fillOpacity = 0.8,
    popup = ~paste("Escuela:", escuela, "<br>",
                   "Tipo gestión:", tipo_gestion),
    group = "Escuelas"
  ) %>%
  
  # Leyenda
  addLegend(
    position = "bottomright",
    colors = c("red", "orange", "blue"),
    labels = c("500m", "1000m", "2000m"),
    title = "Buffer - Distancia"
  ) %>%
  
  # Control de capas
  addLayersControl(
    overlayGroups = c("Buffers", "Escuelas"),
    options = layersControlOptions(collapsed = FALSE)
  )


```


```{r Geoconsulta: Preparacion}
# 1. Convertir barrios vulnerables a puntos (centroide o punto interno)
barriosvul_puntos <- barriosvul_selec %>%
  st_point_on_surface() %>%
  select(Id, barrios_nom, CO_FRAC_RA, TIPO_ASENT, MANZANA, Superficie, geometry)

# 2. Buffer de 500m (manteniendo CRS proyectado)
buffvul500_punto <- barriosvul_puntos %>%
  st_buffer(500) %>%
  mutate(buffer = "500m")

# 3. Filtrar escuelas dentro del buffer
escuelasvul_500 <- st_filter(educ_sna, buffvul500_punto)

# 4. Transformar a 4326 solo para visualización
barriosvul_puntos_wgs <- st_transform(barriosvul_puntos, 4326)
buffvul500_punto_wgs <- st_transform(buffvul500_punto, 4326)
escuelasvul_500_wgs <- st_transform(escuelasvul_500, 4326)

tabla_tiemposvul_500 <- osrmTable(src = barriosvul_puntos_wgs, dst = escuelasvul_500)
df_tiemposvul_500 <- as.data.frame(tabla_tiemposvul_500$durations)
df_tiemposvul_500$radio_id <- rownames(df_tiemposvul_500)
df_tiemposvul_larga_500 <- df_tiemposvul_500 %>%
  pivot_longer(
    cols = -radio_id, 
    names_to = "escuela_id", 
    values_to = "tiempo_min") %>%
  mutate(buffer = "500m")
print(df_tiemposvul_larga_500)


```


```{r}
# Normalizamos columnas antes de unir
df_tiemposcm_larga_5002 <- df_tiemposcm_larga_500 %>%
  mutate(grupo = "Clase media y alta")


df_tiemposvul_larga_5002 <- df_tiemposvul_larga_500 %>%
  mutate(grupo = "Vulnerable")

# Unificamos
df_tiempos_unificado_5002 <- bind_rows(df_tiemposcm_larga_5002, df_tiemposvul_larga_5002)

# Verificamos conteo por grupo
df_tiempos_unificado_5002 %>% count(grupo)
print(df_tiempos_unificado_5002)

```

`

```{r}
resumen_tiempos <- df_tiempos_unificado_5002 %>%
  group_by(grupo, buffer) %>%
  summarise(
    tiempo_promedio = mean(tiempo_min, na.rm = TRUE),
    .groups = "drop"
  )

print(resumen_tiempos)

```
```{r}
library(ggplot2)

ggplot(resumen_tiempos, aes(x = buffer, y = tiempo_promedio, fill = grupo)) +
  geom_col(position = position_dodge()) +
  labs(
    title = "Tiempo promedio a escuelas según grupo y buffer",
    x = "Buffer",
    y = "Tiempo promedio (minutos)",
    fill = "Grupo"
  ) +
  theme_minimal()

```
```{r}


ggplot(df_tiempos_unificado_5002, aes(x = reorder(radio_id, tiempo_min), y = tiempo_min, fill = grupo)) +
  geom_col(position = position_dodge()) +
  coord_flip() +
  labs(
    title = "Tiempo a escuelas (500m) por radio censal y grupo",
    x = "Radio censal",
    y = "Tiempo (minutos)",
    fill = "Grupo"
  ) +
  theme_minimal()


```


```{r}
df_cm <- conteo_escuelas_cm %>%
  mutate(grupo = case_when(
    barrios_nom == "Almagro" ~ "Clase media baja",
    barrios_nom == "Caballito" ~ "Clase media",
    barrios_nom == "Palermo" ~ "Clase media alta"
  ))

df_vul <- conteo_escuelasvul %>%
  mutate(grupo = "Vulnerable")

conteo_comparado <- bind_rows(df_cm, df_vul)
tabla_comparativa <- table(conteo_comparado$grupo, conteo_comparado$buffer)
addmargins(tabla_comparativa)
```

```{r}
library(ggplot2)

ggplot(data = conteo_unificado, aes(x = buffer, y = total, fill = grupo)) +
  geom_col(position = "dodge") +
  labs(
    title = "Cantidad de escuelas por buffer y grupo socioeconómico",
    x = "Buffer",
    y = "Total de escuelas",
    fill = "Grupo socioeconómico"
  ) +
  theme_minimal()

```

